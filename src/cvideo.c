/*
 * cvideo.c
 *
 *  Created on: Nov 30, 2013
 *      Author: petera
 */

#include "cvideo.h"
#include "gpio.h"
#include "miniutils.h"

#define CVID_MIN_HSCANLINE      21
#define CVID_MAX_HSCANLINE      275+CVID_MIN_HSCANLINE
#define CVID_HSCANLINE_BYTE_LEN 29

static u8_t test_pattern[][CVID_HSCANLINE_BYTE_LEN] = {
    {0b00000000, 0b11000110, 0b11111110, 0b00000010, 0b00010000, 0b00010000, 0b00010000,0b00000000, 0b11000110, 0b11111110, 0b00000010, 0b00010000,0b00000000, 0b11000110, 0b11111110, 0b00000010, 0b00010000,0b00000000, 0b11000110, 0b11111110, 0b00000010, 0b00010000,0b00000000, 0b11000110, 0b11111110, 0b00000010, 0b00010000, 0b00010000,0b00000000,},
    {0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000, 0b00111000, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000, 0b00111000,0b00000000,},
    {0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000, 0b00111000, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000,0b00000000, 0b11000110, 0b11000000, 0b00000010, 0b00111000, 0b00111000,0b00000000,},
    {0b00000000, 0b11111110, 0b11110000, 0b00000010, 0b00010000, 0b00010000, 0b00010000,0b00000000, 0b11111110, 0b11110000, 0b00000010, 0b00010000,0b00000000, 0b11111110, 0b11110000, 0b00000010, 0b00010000,0b00000000, 0b11111110, 0b11110000, 0b00000010, 0b00010000,0b00000000, 0b11111110, 0b11110000, 0b00000010, 0b00010000,0b00010000,0b00000000,},
    {0b00000000, 0b11000110, 0b11000000, 0b11000110, 0b00010000, 0b00010000, 0b00010000,0b00000000, 0b11000110, 0b11000000, 0b11000110, 0b00010000,0b00000000, 0b11000110, 0b11000000, 0b11000110, 0b00010000,0b00000000, 0b11000110, 0b11000000, 0b11000110, 0b00010000,0b00000000, 0b11000110, 0b11000000, 0b11000110, 0b00010000, 0b00010000,0b00000000,},
    {0b00000000, 0b11000110, 0b11000000, 0b01101100, 0b00000000, 0b00000000, 0b00000000,0b00000000, 0b11000110, 0b11000000, 0b01101100, 0b00000000,0b00000000, 0b11000110, 0b11000000, 0b01101100, 0b00000000,0b00000000, 0b11000110, 0b11000000, 0b01101100, 0b00000000,0b00000000, 0b11000110, 0b11000000, 0b01101100, 0b00000000, 0b00000000,0b00000000,},
    {0b00000000, 0b11000110, 0b11111110, 0b00111000, 0b00111000, 0b00111000, 0b00111000,0b00000000, 0b11000110, 0b11111110, 0b00111000, 0b00111000,0b00000000, 0b11000110, 0b11111110, 0b00111000, 0b00111000,0b00000000, 0b11000110, 0b11111110, 0b00111000, 0b00111000,0b00000000, 0b11000110, 0b11111110, 0b00111000, 0b00111000, 0b00111000,0b00000000,},
    {0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000,0b00000000,},
};

static struct {
  u8_t vsync_initial;
  volatile bool in_sync;
  volatile u16_t cur_hsync;
  u16_t dbg_last_hsyncs;
} vid;

static void cvideo_disable_output(void) {
  gpio_config(PORTB, PIN15, CLK_50MHZ, IN, AF0, OPENDRAIN, NOPULL);
}

static void cvideo_vsync_irq(gpio_pin pin) {
  vid.dbg_last_hsyncs = vid.cur_hsync;

  if (vid.vsync_initial < 4) {
    vid.vsync_initial++;
    return;
  } else if (vid.vsync_initial == 4){
    vid.vsync_initial = 5;
    return;
  }

  bool nsync = vid.cur_hsync == 320;
  if (nsync != vid.in_sync) {
    if (nsync) {
      gpio_config(PORTB, PIN15, CLK_50MHZ, AF, AF0, PUSHPULL, NOPULL);
    } else {
      cvideo_disable_output();

      vid.in_sync = nsync;
      vid.cur_hsync = 0;
      vid.vsync_initial = 0;

      return;
    }
  }

  vid.in_sync = nsync;
  vid.cur_hsync = 0;
}

static void cvideo_hsync_irq(gpio_pin pin) {
  vid.cur_hsync++;
  if (!vid.in_sync) return;
  if (vid.in_sync &&
      vid.cur_hsync >= CVID_MIN_HSCANLINE && vid.cur_hsync < CVID_MAX_HSCANLINE) {
    DMA1_Channel5->CCR &= (u16_t)(~DMA_CCR1_EN);
    DMA1_Channel5->CNDTR = CVID_HSCANLINE_BYTE_LEN;
    DMA1_Channel5->CMAR = (u32_t)(&test_pattern[(vid.cur_hsync - CVID_MIN_HSCANLINE) & 7][0]);
    DMA1_Channel5->CCR |= DMA_CCR1_EN;
    SPI2->CR1 |= 0x0040;
  }
}

void CVIDEO_init(void) {
  memset(&vid, 0, sizeof(vid));

  cvideo_disable_output();

  gpio_interrupt_config(PORTB, PIN8, cvideo_vsync_irq, FLANK_UP);
  gpio_interrupt_config(PORTB, PIN14, cvideo_hsync_irq, FLANK_UP);
  gpio_interrupt_mask_enable(PORTB, PIN14, TRUE);
  gpio_interrupt_mask_enable(PORTB, PIN8, TRUE);

  gpio_config(PORTB, PIN15, CLK_50MHZ, AF, AF0, PUSHPULL, NOPULL);
}

void CVIDEO_dump(void) {
  gpio_interrupt_mask_disable(PORTB, PIN8);
  gpio_interrupt_mask_disable(PORTB, PIN14);

  // hmm

  gpio_interrupt_mask_enable(PORTB, PIN8, TRUE);
  gpio_interrupt_mask_enable(PORTB, PIN14, TRUE);
}
